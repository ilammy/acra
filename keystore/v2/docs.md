NOTE: This is draft of documentation to be published [on the doc server](https://docs.cossacklabs.com/pages/documentation-acra/#key-management).

## Key management

There are several types of keys used in Acra:

  * **Keys for transport encryption.**
    Acra uses either [Themis Secure Session](/pages/secure-session-cryptosystem/) or TLS
    as transport protection between AcraServer and AcraConnector, or AcraTranslator and AcraConnector.

    In Themis Secure Session mode, Acra uses transport keypairs:
    the two parties should exchange public keys, keeping the private keys to themselves.
    In TLS mode, Acra uses TLS certificates instead of transport keypairs.

  * **Storage keypair.**
    AcraWriter uses the public key for data encryption.
    AcraServer/AcraTranslator use private storage key for data decryption.

  * Authentication storage key for encryption/decryption credentials of AcraWebConfig users.

  * Acra Enterprise Edition has more keys powering features like searchable encryption, tamper-proof audit log, etc.

Storage keys can be represented by either:

  * One keypair for each unique *Client ID* ([default Zone mode](/pages/documentation-acra/#zones)),
    which is used for encryption by AcraWriter and decryption by AcraServer/AcraTranslator
    (so, in fact, there can be many such keypairs: one for each client ID).

  * A set of *Zone keys* ([multiple Zone mode](/pages/documentation-acra/#zones)).
    Each Zone represents a unique user or type of users and has corresponding encryption and decryption keys.
    Using Zones complicates unwanted decryption:
    the attacker not only needs to get the decryption key but to use a correct Zone ID, too.

### Key names and locations

> **Note:**
> Read more about handling keys in [Losing your keys](/pages/documentation-acra/#losing-your-keys)
> and [Renaming your keys](/pages/documentation-acra/#renaming-your-keys).

Each Acra component has to have its own key folder (by default it is `.acrakeys`)
that contains a set of keys necessary for the correct operation of the component:

  - **AcraConnector** needs the following keys to establish a [Secure Session connection](/pages/secure-session-cryptosystem/).

    - AcraConnector’s own transport private key.

    - Other party transport public key.

      You should put transport public key of AcraServer or AcraTranslator into AcraConnector’s key folder, depending on the connection type.

  - **AcraServer** works with the following keys:

    - AcraServer’s own transport private key as well as AcraConnector’s transport public key.

      They are necessary for accepting connections from the clients via Secure Session.

    - Storage private key(s) for decrypting AcraStructs generated by AcraWriter.

    - If AcraServer is running in [Transparent proxy mode](/pages/documentation-acra/#transparent-proxy-mode),
      it should possess the storage public key(s) for encrypting the values from SQL queries to AcraStructs.

  - **AcraTranslator** needs to have the following keys:

    - AcraTranslator’s own transport private key along with AcraConnector’s transport public key.

      They are necessary for accepting connections from the clients via Secure Session.

    - Storage private key(s) for decrypting AcraStructs generated by AcraWriter.

  - **AcraWriter** should have the storage public key(s).

    They are necessary for encrypting data into AcraStructs in such a way that would only be readable for AcraServer/AcraTranslator.

  - If you’re using *AcraWebConfig* HTTP server to configure AcraServer remotely,
    the users’ credentials are stored encrypted with authentication storage key and are decrypted on AcraServer upon users’ login.
    **AcraServer** needs to have an authentication storage key.

<!-- TODO: describe Acra EE keys? -->

#### Keys table

| Purpose | Private key stays on | Public key exchanged with |
| ------- | -------------------- | ------------------------- |
| Transport: AcraConnector          | AcraConnector     | → AcraServer<br/>→ AcraTranslator |
| Transport: AcraServer             | AcraServer        | → AcraConnector |
| Transport: AcraTranslator         | AcraTranslator    | → AcraConnector |
| Data encryption (AcraStruct)      | AcraServer<br/>AcraTranslator | → AcraWriter<br/>→ AcraServer in Transparent proxy mode |
| Authentication storage key<br/>for AcraWebConfig’s users | AcraServer | |

### Key store versions

We keep improving key storage and management in Acra.
Starting from version 0.86 all Acra services support a new storage format: key store version 2.
New features include:

  - Stronger key integrity validation, preventing even more tamepring attempts.
  - Improved paritioning of the keys, allowing for simpler configuration correctness checks.
  - Tracking additional key metadata, such as key validity periods and active states.
  - Compliance with best practices and recommendations,
    such as [NIST SP 800-57](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-57pt1r4.pdf).
  - Support for more external KMS types (only in Acra Enterprise Edition).

Key store version 1 is the current version, used by new Acra instances by default.
You can *opt in* the new version 2 when generating keys by using the `--keystore=v2` option.
Acra components can tell which key store version is currently in use,
so special attention is necessary only during the initial key generation and exchange.

Of course it is also possible to convert existing key folders into the new format.
See [Migrating from key store v1](/pages/documentation-acra/#migrating-from-key-store-v1)
on how to migrate existing Acra deployments to the new key store version.

Key store version affects only the storage format, not the content of the keys which stays the same.
This means that Acra components can run with different key store versions.
For example, AcraServer may use improved version 2 while AcraConnector is still using version 1.

### Generating all the Acra keys in one go

We described many keys here and the private keys are those ones that are (obviously) stored in an encrypted form.
There are very special **master keys** that are used by each Acra service to decrypt private keys as necessary.
Look after the master keys very carefully!
If you lose them, all your data is gone.

> **Note:**
> Due to security reasons,
> AcraConnector and AcraServer/AcraTranslator need to have *different* master keys.

Current key store version 1 uses one master key called `ACRA_MASTER_KEY`.
New key store version 2 uses two distinct master keys: `ACRA_MASTER_ENCRYPTION_KEY` and `ACRA_MASTER_SIGNATURE_KEY`.

#### 1.1 Generating master keys on AcraServer/AcraTranslator

Use `acra-keymaker` utility to generate new master key and save it into a file.
By default, Acra components retrieve master keys from environment variables as base64-encoded strings.
Acra Enterprise Edition supports more options,
such as hardware security modules (HSM) and external key management services (KMS).

Generate a new key and assign it to the environment variable on the corresponding server:

```shell
go install github.com/cossacklabs/acra/cmd/acra-keymaker

$GOPATH/bin/acra-keymaker --generate_master_key=master.key

export ACRA_MASTER_KEY=$(cat master.key | base64)
```

With key store version 2 you will need to generate two different master keys:

```shell
$GOPATH/bin/acra-keymaker --generate_master_key=master_encryption.key
$GOPATH/bin/acra-keymaker --generate_master_key=master_signature.key

export ACRA_MASTER_ENCRYPTION_KEY=$(cat master_encryption.key | base64)
export ACRA_MASTER_SIGNATURE_KEY=$(cat master_signature.key | base64)
```

#### 1.2 Generating transport and encryption keys on AcraServer/AcraTranslator

After you set up the master keys,
all private keys generated by `acra-keymaker` will be encrypted before they are written to disk.

Now, let’s generate keypairs for Acra’s services:

```shell
$GOPATH/bin/acra-keymaker --client_id=your_client_ID --generate_acraserver_keys
$GOPATH/bin/acra-keymaker --client_id=your_client_ID --generate_acratranslator_keys
$GOPATH/bin/acra-keymaker --client_id=your_client_ID --generate_acrawriter_keys
$GOPATH/bin/acra-keymaker --client_id=your_client_ID --generate_acrawebconfig_keys
```

Carry out these operations on the machine running AcraServer/AcraTranslator
to make sure that the private keys for Acra never leak outside from the server.

The generator will generate and place resulting keys into the `.acrakeys` directory
(you can change the destination with the `--keys_output_dir` option):

```
.acrakeys
├── auth_key
├── your_client_ID_server
├── your_client_ID_server.pub
├── your_client_ID_storage
├── your_client_ID_storage.pub
├── your_client_ID_translator
└── your_client_ID_translator.pub
```

> **Note:**
> Stored keys should not be world-readable.
> `acra-keymaker` generates keys with proper access permissions:
>
>   - `.acrakeys` directory: `rwx------` (700)
>   - private key files: `rw-------` (600)
>
> AcraServer and AcraTranslator check this and will refuse to launch if access to the keys is not properly restricted.

If you are running Acra 0.86+ and wish to use the new [key store version 2](/pages/documentation-acra/#key-store-versions),
add `--keystore=v2` option when generating the keys:

```shell
$GOPATH/bin/acra-keymaker --keystore=v2 --client_id=your_client_ID --generate_acraserver_keys
# ...
```

In this case the directory layout will be a bit different:

```
.acrakeys
├── authentication.keyring
├── client
│   └── your_client_ID
│       ├── storage.keyring
│       └── transport
│           ├── server.keyring
│           └── translator.keyring
└── version
```

#### 2.1 Generating master keys on AcraConnector

Generate a second set of master keys for AcraConnector in the same way,
but on the server that runs AcraConnector:

```shell
go install github.com/cossacklabs/acra/cmd/acra-keymaker

$GOPATH/bin/acra-keymaker --generate_master_key=master.key

export ACRA_MASTER_KEY=$(cat master.key | base64)
```

If you are going to use key store version 2, you will need two master keys:

```shell
$GOPATH/bin/acra-keymaker --generate_master_key=master_encryption.key
$GOPATH/bin/acra-keymaker --generate_master_key=master_signature.key

export ACRA_MASTER_ENCRYPTION_KEY=$(cat master_encryption.key | base64)
export ACRA_MASTER_SIGNATURE_KEY=$(cat master_signature.key | base64)
```

#### 2.2 Generating transport keys on AcraConnector

Similarly generate transport key for AcraConnector:

```
$GOPATH/bin/acra-keymaker --client_id=your_client_ID --generate_acraconnector_keys
```

Carry out these operations on the machine running AcraConnector to make sure that the private keys of AcraConnector never leak outside it.

The generator will generate and place 2 keys into the `.acrakeys` directory (you can change this with `--keys_output_dir` argument):

```bash
.acrakeys
├── your_client_ID
└── your_client_ID.pub
```

> **Note:**
> Stored keys should not be world-readable.
> `acra-keymaker` generates keys with proper access permissions:
>
>   - `.acrakeys` directory: `rwx------` (700)
>   - private key files: `rw-------` (600)
>
> AcraConnector checks this and will refuse to launch if access to the keys is not properly restricted.

If you are running Acra 0.86+ and wish to use the new [key store version 2](/pages/documentation-acra/#key-store-versions),
add `--keystore=v2` option when generating the keys:

```
$GOPATH/bin/acra-keymaker --keystore=v2 --client_id=your_client_ID --generate_acraconnector_keys
```

In this case the resulting directory layout will be a bit different:

```
.acrakeys
├── client
│   └── your_client_ID
│       └── transport
│           └── connector.keyring
└── version
```

#### 3. Key exchange

The rule is simple: private keys should stay where they were generated and the public key should be moved to the other server/side.

##### 3.1 Exchange transport keys between AcraConnector and AcraServer

Place public key of AcraServer on AcraConnector and place public key of AcraConnector on AcraServer.

| Component | should contain keys | named like these |
| --- | --- | --- |
| AcraConnector | transport public key of AcraServer<br/>transport private key of AcraConnector | `.acrakeys/someid_server.pub`<br/>`.acrakeys/someid` |
| AcraServer | transport public key of AcraConnector<br/>transport private key of AcraServer | `.acrakeys/someid.pub`<br/>`.acrakeys/someid_server` |

##### 3.2 Exchange transport keys between AcraConnector and AcraTranslator

Place public key of AcraTranslator on AcraConnector and public key of AcraConnector on AcraTranslator.

| Component | should contain keys | named like these |
| --- | --- | --- |
| AcraConnector | transport public key of AcraTranslator<br/>transport private key of AcraConnector | `.acrakeys/someid_translator.pub`<br/>`.acrakeys/someid` |
| AcraTranslator | transport public key of AcraConnector<br/>transport private key of AcraTranslator | `.acrakeys/someid.pub`<br/>`.acrakeys/someid_translator` |

##### 3.3 Exchange AcraStruct encryption/decryption keys between AcraWriter and AcraServer/AcraTranslator

| Component | should contain key | named like this |
| --- | --- | --- |
| AcraWriter | storage public key | `.acrakeys/someid_storage.pub` |
| AcraServer | storage private key | `.acrakeys/someid_storage` |
| AcraTranslator | storage private key | `.acrakeys/someid_storage` |

##### 3.4 Exchange AcraStruct Zone keys between AcraWriter and AcraServer/AcraTranslator

Generating Zone keys is different from generating usual AcraStruct encryption keys. You should run `acra-addzone` on AcraServer to generate zone:

```
go install ./cmd/acra-addzone
$GOPATH/bin/acra-addzone
```

When you run it, you should receive a JSON object that looks something like this:

```
{"id":"DDDDDDDDQHpbUSOgYTzqCktp","public_key":"VUVDMgAAAC3yMBGsAmK/wBXZkL8iBv/C+7hqoQtSZpYoi4fZYMafkJbWe2dL"}
```

By decoding a base64-wrapped public key, you get a binary Zone key which should be provided (placed into) to AcraWriter for generating AcraStructs. Zone keys are placed into the key folder and are named `zoneid_zone` for private key and `zoneid_zone.pub` for public key.

| Component | should contain key | named like this |
| --- | --- | --- |
| AcraWriter | zone public key | `.acrakeys/zoneid_zone.pub` |
| AcraServer | zone private key | `.acrakeys/zoneid_zone` |
| AcraTranslator | zone private key | `.acrakeys/zoneid_zone` |

Read more about using Zones in the [AcraWriter guide](/pages/documentation-acra/#acraconnector-and-acrawriter#writing).

### Operating the key store

#### (Re)Generating only some of the keys

If you want to update or re-generate (rotate) only some particular keys,
it can be easily done via CLI parameters for `acra-keymaker`:

| Parameter | Key |
| --------- | --- |
| `--generate_acraconnector_keys`   | AcraConnector transport keypair     |
| `--generate_acraserver_keys`      | AcraServer transport keypair        |
| `--generate_acratranslator_keys`  | AcraTranslator transport keypair    |
| `--generate_acrawriter_keys`      | data storage keypair for AcraWriter |
| `--generate_acrawebconfig_keys`   | symmetric key for AcraWebconfig     |
| `--generate_master_key`           | new master keys for all services    |

Remember to share newly generated public keys with peer services that need them:

  - AcraConnector public key → AcraServer/AcraTranslator
  - AcraServer public key → AcraConnector
  - AcraTranslator public key → AcraConnector
  - data storage public key → AcraWriter (private key stays on AcraServer/AcraTranslator)

Also remember to use separate master key sets for AcraConnector and AcraServer/AcraTranslator.

> **⚠️ Note:**
> After generating a new master key you *have to* reinitialise the key store.
> If you don’t do it, Acra services will not be able decrypt old private keys,
> and thus will not be able to communicate or decrypt any data at all.
>
> If you update the encryption key (`ACRA_MASTER_KEY` or `ACRA_MASTER_ENCRYPTION_KEY`),
> you need to regenerate all relevant private keys with `acra-keymaker`
> (and then distribute new public keys to peers).
>
> If you update the signature key (`ACRA_MASTER_SIGNATURE_KEY`),
> you need to reimport the entire key store in order to resign it.
> <!-- TODO: And what tool should I use for that?.. -->

Old versions of the keys are preserved after rotation.
With key store version 1, previous keys are stored in `.old` directories:

```
.acrakeys
├── your_client_ID_storage
├── your_client_ID_storage.old
│   └── 2020-03-27T07:47:47.929575
├── your_client_ID_storage.pub
└── your_client_ID_storage.pub.old
    └── 2020-03-27T07:47:47.930778
```

Key store version 2 stores all key versions together inside the `.keyring` files.

### Renaming your keys

Acra stores private keys in encrypted form. Each key has a special filename associated with its `<client_id>`.

The keys are encrypted using Authenticated Encryption with Associated Data (AEAD), where `<client_id>` acts as associated data for AEAD. This means that if you rename any private key (transport, storage, poison_record key, etc.) in the filesystem and lose the information about its former name, Acra won’t be able to decrypt the key. In this case, it’ll be impossible to decrypt the data and you will lose it (if you have no backup).

Do not rename your key(s). If you did – rename the key(s) back to `<client_id>_<key type>` before attempting to decrypt your data.


### Losing your keys

If you lose the [master key](/pages/documentation-acra/#generating-all-the-acra-keys-in-one-go) that’s used for launching AcraServer, you won’t be able to decrypt the data. Yes, it means that there will be no way to decrypt the data and you’ll lose if forever. Store the master key safely!

If the private keys are lost, there will be no way to decrypt the data either. Store the private keys safely!

We recommend storing private keys and the master key in a reliable place (i.e. KMS, HSM).

[Acra Pro and Acra EE users](https://www.cossacklabs.com/acra/#pricing) have a chance to retrieve their public keys if you still have your private keys and master keys. If you’ve encountered such a problem, please [contact us](mailto:dev@cossacklabs.com).

### Migrating from key store v1

### Key decryption errors

You may encounter the following error messages produced by AcraConnector:

```
time="2019-04-03T11:43:16Z" level=info msg="Connect to AcraServer" client_id=backend_client connection_string="tcp://acraserver-acralivedemo:9393/"
time="2019-04-03T11:43:16Z" level=error msg="Can't wrap connection" client_id=backend_client code=538 error="Failed to unprotect data"
time="2019-04-03T11:43:16Z" level=info msg="Close connection with client" client_id=backend_client
```

And by AcraServer:

```
time="2019-04-03T11:43:57Z" level=info msg="Got new connection to AcraServer: 172.20.0.3:42164" connection_string="tcp://0.0.0.0:9393" from_descriptor=false
time="2019-04-03T11:43:57Z" level=error msg="Can't wrap connection from acra-connector" code=538 error=EOF
```

As `"Can't wrap connection"` and `"Failed to unprotect data"` error messages suggest, this means that AcraServer or AcraConnector cannot decrypt the private transport key necessary to initialise Secure Session.

Possible reasons why AcraServer or AcraConnector can’t decrypt the private keys:

* keys were renamed
* keys were rewritten with other keys
* keys are associated with another `<client_id>`

Make sure that you haven’t renamed the keys and [rename them back](/pages/documentation-acra/#renaming-your-keys) if possible.
