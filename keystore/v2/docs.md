NOTE: This is draft of documentation to be published [on the doc server](https://docs.cossacklabs.com/pages/documentation-acra/#key-management).

## Key management

There are several types of keys used in Acra:

* Keys for transport encryption. Acra uses either [Themis Secure Session](/pages/secure-session-cryptosystem/) or TLS as transport protection between AcraServer and AcraConnector, or AcraTranslator and AcraConnector. In Themis Secure Session mode, Acra uses transport keypairs: the two parties should exchange public keys, keeping the private keys to themselves. In TLS mode, Acra uses TLS certificates instead of transport keypairs.

* Storage keypair: AcraWriter uses the public key for data encryption, AcraServer/AcraTranslator use private storage key for data decryption.

* Authentication storage key for encryption/decryption credentials of AcraWebConfig users.

Storage keys can be represented by either:

  * One keypair for each unique `client_id`([default Zone mode](/pages/documentation-acra/#zones)), which is used for encryption by AcraWriter and decryption by AcraServer/AcraTranslator (so, in fact, there can be many such keypairs, one for each `client_id`).
  * A set of Zone keys ([multiple Zone mode](/pages/documentation-acra/#zones)). Each Zone represents a unique user or type of users and has corresponding encryption and decryption keys. Using Zones complicates unwanted decryption: the attacker not only needs to get the decryption key but to use a correct Zone Id, too.

### Key names and locations

> Note: Read more about handling key names in [Losing your keys](/pages/documentation-acra/#losing-your-keys) and [Renaming your keys](/pages/documentation-acra/#renaming-your-keys).

Each Acra component has to have its own key folder (by default it is `.acrakeys`) that contains a set of keys necessary for the correct functioning of the components:

- AcraConnector needs to have its own transport private key and other party transport public key to establish a [Secure Session connection](/pages/secure-session-cryptosystem/). You should put transport public key of AcraServer or AcraTranslator into AcraConnector's key folder, depending on the connection type.

- AcraServer should have:
    - AcraConnector's transport public key and AcraServer's own transport private key. This is necessary for accepting connections from clients via Secure Session
    - Storage private key(s) for decrypting AcraStructs generated by AcraWriter.
    - If AcraServer is running in [Transparent proxy mode](/pages/documentation-acra/#transparent-proxy-mode), it should possess the storage public key(s) for encrypting the values from SQL queries to AcraStructs.

- AcraTranslator needs to have:
    - AcraConnector's transport public key and AcraTranslator's own transport private key. This is necessary for accepting connections via Secure Session from the clients.
    - Storage private key(s) for decrypting AcraStructs generated by AcraWriter.

- AcraWriter should have the storage public key(s). They are necessary for encrypting data into AcraStructs in such a way that would only be readable for AcraServer/AcraTranslator.

- If you're using AcraWebConfig HTTP server to configure AcraServer remotely, the users' credentials are stored encrypted with authentication storage key and are decrypted on AcraServer upon users' login. AcraServer needs to have an authentication storage key.

#### Keys table

| Purpose  | Private key  | Stays on  | Public key  |Put to  |
--- | --- | --- | --- | ---
| Transport AcraConnector | clientid | AcraConnector | clientid.pub | -> AcraServer<br/>-> AcraTranslator |
| Transport AcraServer | clientid_server| AcraServer | clientid_server.pub | -> AcraConnector |
| Transport AcraTranslator | clientid_translator| AcraTranslator | clientid_translator.pub | -> AcraConnector |
| AcraStruct encryption |  |  | clientid_storage.pub | -> AcraWriter<br/>-> AcraServer in Transparent proxy mode |
| AcraStruct decryption | clientid_storage | AcraServer/<br/>AcraTranslator |  |  |
| AcraStruct encryption with Zones |  |  | zoneid_zone.pub | -> AcraWriter<br/>-> AcraServer in Transparent proxy mode |
| AcraStruct decryption with Zones | zoneid_zone | AcraServer/<br/>AcraTranslator |  |  |
| Authentication storage key<br/>for AcraWebConfig's users | auth_key| AcraServer | | |

### Generating all the Acra keys in one go

We described many keys here and the private keys are those keys that are (obviously) stored in an encrypted form. There's a very special key `ACRA_MASTER_KEY` that is used for decryption of private keys for every Acra service. Look after this key very carefully!

> Note: Due to security reasons, AcraConnector and AcraServer/AcraTranslator need to have different `ACRA_MASTER_KEY`.

#### 1.1 Generating `ACRA_MASTER_KEY` on AcraServer/AcraTranslator

Use `acra-keymaker` to generate master key into `master.key` file and assign it into the environment variable on the corresponding server:

```
go install github.com/cossacklabs/acra/cmd/acra-keymaker
$GOPATH/bin/acra-keymaker --generate_master_key=master.key
export ACRA_MASTER_KEY=`cat master.key | base64`
```

#### 1.2 Generating transport and encryption keys on AcraServer/AcraTranslator

After this, the master key will be used by `acra-keymaker` for encryption of private keys before those are written to the disk.

Now, let's generate keypairs for Acra's services:

```
$GOPATH/bin/acra-keymaker --client_id=someid --generate_acraserver_keys
$GOPATH/bin/acra-keymaker --client_id=someid --generate_acratranslator_keys
$GOPATH/bin/acra-keymaker --client_id=someid --generate_acrawriter_keys
$GOPATH/bin/acra-keymaker --client_id=someid --generate_acrawebconfig_keys
```

Carry out these operations on the machine running AcraServer/AcraTranslator to make sure that the private keys for Acra never leak outside from the server.

The generator will generate and place 6 keys into the `.acrakeys` directory (you can change
this with `--keys_output_dir` argument):

```bash
.acrakeys/auth_key
.acrakeys/someid_server
.acrakeys/someid_server.pub
.acrakeys/someid_storage
.acrakeys/someid_storage.pub
.acrakeys/someid_translator
.acrakeys/someid_translator.pub
```

> Note: For `acra` to work properly, the key folders have to have proper permissions as set by `acra-keymaker`:

* folder 700.
* private keys 600.

#### 2.1 Generating `ACRA_MASTER_KEY` on AcraConnector

Generate second `ACRA_MASTER_KEY` for AcraConnector in the same way, but on the server that runs AcraConnector:

```
go install github.com/cossacklabs/acra/cmd/acra-keymaker
$GOPATH/bin/acra-keymaker --generate_master_key=master.key
export ACRA_MASTER_KEY=`cat master.key | base64`
```

#### 2.2 Generating transport keys on AcraConnector

Similarly generate transport key for AcraConnector:

```
$GOPATH/bin/acra-keymaker --client_id=someid --generate_acraconnector_keys
```

Carry out these operations on the machine running AcraConnector to make sure that the private keys of AcraConnector never leak outside it.

The generator will generate and place 2 keys into the `.acrakeys` directory (you can change this with `--keys_output_dir` argument):

```bash
.acrakeys/someid
.acrakeys/someid.pub
```

> Note: For `acra` to work properly, the key folders have to have proper permissions as set by `acra-keymaker`:

* folder 700.
* private keys 600.


#### 3. Key exchange

The rule is simple: private keys should stay where they were generated and the public key should be moved to the other server/side.

##### 3.1 Exchange transport keys between AcraConnector and AcraServer

Place public key of AcraServer on AcraConnector and place public key of AcraConnector on AcraServer.

| Component | should contain keys | named like these |
| --- | --- | --- |
| AcraConnector | transport public key of AcraServer<br/>transport private key of AcraConnector | `.acrakeys/someid_server.pub`<br/>`.acrakeys/someid` |
| AcraServer | transport public key of AcraConnector<br/>transport private key of AcraServer | `.acrakeys/someid.pub`<br/>`.acrakeys/someid_server` |

##### 3.2 Exchange transport keys between AcraConnector and AcraTranslator

Place public key of AcraTranslator on AcraConnector and public key of AcraConnector on AcraTranslator.

| Component | should contain keys | named like these |
| --- | --- | --- |
| AcraConnector | transport public key of AcraTranslator<br/>transport private key of AcraConnector | `.acrakeys/someid_translator.pub`<br/>`.acrakeys/someid` |
| AcraTranslator | transport public key of AcraConnector<br/>transport private key of AcraTranslator | `.acrakeys/someid.pub`<br/>`.acrakeys/someid_translator` |

##### 3.3 Exchange AcraStruct encryption/decryption keys between AcraWriter and AcraServer/AcraTranslator

| Component | should contain key | named like this |
| --- | --- | --- |
| AcraWriter | storage public key | `.acrakeys/someid_storage.pub` |
| AcraServer | storage private key | `.acrakeys/someid_storage` |
| AcraTranslator | storage private key | `.acrakeys/someid_storage` |

##### 3.4 Exchange AcraStruct Zone keys between AcraWriter and AcraServer/AcraTranslator

Generating Zone keys is different from generating usual AcraStruct encryption keys. You should run `acra-addzone` on AcraServer to generate zone:

```
go install ./cmd/acra-addzone
$GOPATH/bin/acra-addzone
```

When you run it, you should receive a JSON object that looks something like this:

```
{"id":"DDDDDDDDQHpbUSOgYTzqCktp","public_key":"VUVDMgAAAC3yMBGsAmK/wBXZkL8iBv/C+7hqoQtSZpYoi4fZYMafkJbWe2dL"}
```

By decoding a base64-wrapped public key, you get a binary Zone key which should be provided (placed into) to AcraWriter for generating AcraStructs. Zone keys are placed into the key folder and are named `zoneid_zone` for private key and `zoneid_zone.pub` for public key.

| Component | should contain key | named like this |
| --- | --- | --- |
| AcraWriter | zone public key | `.acrakeys/zoneid_zone.pub` |
| AcraServer | zone private key | `.acrakeys/zoneid_zone` |
| AcraTranslator | zone private key | `.acrakeys/zoneid_zone` |

Read more about using Zones in the [AcraWriter guide](/pages/documentation-acra/#acraconnector-and-acrawriter#writing).

### (Re)Generating only some of the keys

If you want to update or re-generate only some particular keys, it can be easily done via CLI parameters for `acra-keymaker`:

- `--generate_acraconnector_keys` – generates AcraConnector transport keypair;
- `--generate_acraserver_keys` – generates AcraServer transport keypair;
- `--generate_acratranslator_keys` – generates AcraTranslator transport keypair;
- `--generate_acrawriter_keys` – generates data storage keypair to be split between AcraWriter and AcraServer/AcraTranslator;
- `--generate_acrawebconfig_keys` – generates a symmetric key for encrypting credentials of AcraWebconfig' users;
- `--generate_master_key` – generates new `ACRA_MASTER_KEY`, all private keys should be re-generated after changing master key.

Remember to use separate `ACRA_MASTER_KEY` for AcraConnector and AcraServer/AcraTranslator.

If you suddenly update `ACRA_MASTER_KEY` on AcraServer/AcraTranslator, it won't be able to decrypt old private keys (thus won't be able to decrypt AcraStructs/data at all).

### Renaming your keys

Acra stores private keys in encrypted form. Each key has a special filename associated with its `<client_id>`.

The keys are encrypted using Authenticated Encryption with Associated Data (AEAD), where `<client_id>` acts as associated data for AEAD. This means that if you rename any private key (transport, storage, poison_record key, etc.) in the filesystem and lose the information about its former name, Acra won’t be able to decrypt the key. In this case, it’ll be impossible to decrypt the data and you will lose it (if you have no backup).

Do not rename your key(s). If you did – rename the key(s) back to `<client_id>_<key type>` before attempting to decrypt your data.


### Losing your keys

If you lose the [master key](/pages/documentation-acra/#generating-all-the-acra-keys-in-one-go) that’s used for launching AcraServer, you won’t be able to decrypt the data. Yes, it means that there will be no way to decrypt the data and you’ll lose if forever. Store the master key safely!

If the private keys are lost, there will be no way to decrypt the data either. Store the private keys safely!

We recommend storing private keys and the master key in a reliable place (i.e. KMS, HSM).

[Acra Pro and Acra EE users](https://www.cossacklabs.com/acra/#pricing) have a chance to retrieve their public keys if you still have your private keys and master keys. If you’ve encountered such a problem, please [contact us](mailto:dev@cossacklabs.com).

### Key decryption errors

You may encounter the following error messages produced by AcraConnector:

```
time="2019-04-03T11:43:16Z" level=info msg="Connect to AcraServer" client_id=backend_client connection_string="tcp://acraserver-acralivedemo:9393/"
time="2019-04-03T11:43:16Z" level=error msg="Can't wrap connection" client_id=backend_client code=538 error="Failed to unprotect data"
time="2019-04-03T11:43:16Z" level=info msg="Close connection with client" client_id=backend_client
```

And by AcraServer:

```
time="2019-04-03T11:43:57Z" level=info msg="Got new connection to AcraServer: 172.20.0.3:42164" connection_string="tcp://0.0.0.0:9393" from_descriptor=false
time="2019-04-03T11:43:57Z" level=error msg="Can't wrap connection from acra-connector" code=538 error=EOF
```

As `"Can't wrap connection"` and `"Failed to unprotect data"` error messages suggest, this means that AcraServer or AcraConnector cannot decrypt the private transport key necessary to initialise Secure Session.

Possible reasons why AcraServer or AcraConnector can’t decrypt the private keys:

* keys were renamed
* keys were rewritten with other keys
* keys are associated with another `<client_id>`

Make sure that you haven’t renamed the keys and [rename them back](/pages/documentation-acra/#renaming-your-keys) if possible.
